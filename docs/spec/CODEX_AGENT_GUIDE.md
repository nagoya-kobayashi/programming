# CODEX_AGENT_GUIDE – VS Code Code Assistant 運用ガイド

この文書は、VS Code の Code Assistant（以下 Codex）がこのリポジトリを扱う際の行動規範と作業手順を定めるものです。

**必須ルール**：  
作業を開始する前に、必ず以下のファイルを読み、内容を尊重してください。

- `/docs/spec/AGENT_GUIDE.md`   … システムの構造・注意点（人間開発者向け）
- `/docs/spec/TECH_SPEC.md`     … 詳細な技術仕様
- `/docs/spec/BUGS_AND_RISKS.md` … 既知バグとリスク
- この `/docs/spec/CODEX_AGENT_GUIDE.md` … あなた自身（Codex）の行動ルール

---

## 1. あなた（Codex）の役割

- このリポジトリに対する **保守・改修・リファクタリング・仕様反映** を行う。
- ユーザーからの指示に従い、  
  - **プログラムソース（HTML/JS/CSS/GAS）**  
  - **仕様書（.md ファイル）**  
  の両方を **直接編集** してよい。
- `diff` 形式のパッチを出力するのではなく、  
  **実際のファイルを開き、部分編集・追記・削除を行うことが前提**。

---

## 2. 編集ポリシー（絶対に守るべきこと）

1. **既存仕様の尊重**
   - まず `AGENT_GUIDE.md` と `TECH_SPEC.md` の仕様を確認し、  
     それと矛盾する変更は行わない。
   - 仕様変更が必要な場合は、コード変更と同時に `.md` の仕様も更新する。

2. **最小限かつ局所的な変更**
   - 目的を達成するために必要な範囲に変更を限定する。
   - 無関係なコードの書き換えや、スタイルの“趣味的変更”は行わない。

3. **ファイルの責務を崩さない**
   - 画面ごとの役割や JS ファイルの責務分担は `AGENT_GUIDE.md` に従う。
   - 新しい機能を追加する際は、既存の責務分割を尊重し、  
     無理に 1 ファイルに詰め込まない。

4. **日本語コメントと文字コード**
   - すでにある日本語コメントのスタイルに合わせる。
   - 新規コメントも日本語で記述する。
   - エンコード前提（UTF-8）を壊さないように、  
     不要なエスケープや文字コード変換を行わない。

5. **通信仕様・スプレッドシート仕様を壊さない**
   - GAS 側の関数シグネチャ（引数・返り値）やスプレッドシート列構造は、  
     仕様書に従って慎重に扱う。
   - 変更が必要な場合は、クライアント側・サーバ側・仕様書の  
     すべてを同期させる。

---

## 3. 作業の基本フロー

Codex は、次のフローに従って作業すること。

1. **ユーザーの指示を要約**
   - 何を達成したいのか（バグ修正／機能追加／リファクタ／仕様反映など）を  
     自分なりに短く整理する。

2. **関連ドキュメントを確認**
   - `/docs/spec/AGENT_GUIDE.md`
   - `/docs/spec/TECH_SPEC.md`
   - `/docs/spec/DATA_FLOW.md`
   - `/docs/spec/BUGS_AND_RISKS.md`
   を開き、関連する部分を確認する。

3. **関連ソースファイルを特定**
   - HTML（画面）、JS、CSS、GAS のうち、  
     どのファイルが今回の変更に関係するかをリストアップする。

4. **編集方針を決定**
   - どのファイルのどの関数・どの UI 要素をどう変えるかを考える。
   - 可能なら、簡単な「変更計画」をコメントとして一時的にファイル冒頭に記載してから作業を始める。

5. **コードと .md を同時に更新**
   - 実装を変更したら、対応する仕様書（TECH_SPEC / DATA_FLOW / BUGS_AND_RISKS など）も更新する。
   - 仕様書側に「変更履歴」や「注意点」を追記し、将来の開発者が理解しやすいようにする。

6. **自己チェック**
   - 変更箇所を読み直し、  
     - 既存仕様との矛盾  
     - 変数名や ID のタイプミス  
     - セッション・認証まわりの抜け  
     を確認する。
   - 必要に応じて TODO や NOTE コメントを残す。

---

## 4. 触るときに特に注意すべきポイント

（以下は既存の `AGENT_GUIDE.md` から参照する内容の抜粋方針。詳細はそちらを読むこと）

- セッション検証・ログイン処理（`index.html` / `login.html`）
- フロントから GAS への送信経路（`comm_payload.js`, `sheet_io.js`, `task_selection.js`, `task_editor.js`）
- Pyodide Worker と UI の連携（`py_worker.js`, `runner.js`）
- スプレッドシートの列構成と整合性チェック
- `config.js` による環境切り替え（本番／テスト）

これらは、システム全体を壊しやすい箇所なので、  
変更時は必ず `AGENT_GUIDE.md` の該当節と TECH_SPEC を読み直すこと。

---

## 5. 将来拡張時のルール

- 新しい画面や大規模な機能追加を行う場合、  
  **まず `/docs/spec/TECH_SPEC.md` と `/docs/spec/DATA_FLOW.md` に計画レベルの仕様を追記**し、  
  その上でコードを実装すること。
- 既知バグを修正した場合は、  
  `/docs/spec/BUGS_AND_RISKS.md` に  
  - 状態（未解決 → 解決済）  
  - 修正方法の概要  
  を追記すること。

