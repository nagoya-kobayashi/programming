# 既知バグ・仕様的リスク

本書では現行システムの既知不具合と潜在的なリスクをまとめます。表ではカテゴリと概要および優先度を一覧し、その後に詳細と推定原因を述べます。優先度は重大度と再発リスクを考慮し High(H)/Medium(M)/Low(L) の 3 段階で付けています。

| カテゴリ     | 問題                                                                       | 優先度 |
| -------- | ------------------------------------------------------------------------ | --- |
| セッション・認証 | `ping` エンドポイントが POST 未対応で常に `missing taskId` エラーになる                      | H   |
| セッション・認証 | セッション TTL が 0 で無期限になりレコードが増え続ける                                          | M   |
| セッション・認証 | `saveTask`/`saveUserCode` が無認証で実行可能 (id 指定だけで他人データを上書き)                  | H   |
| セッション・認証 | SALT とハッシュを GET クエリで送信しておりログに残る                                          | M   |
| セッション・認証 | パスワード変更画面が存在するがサーバー側にエンドポイントが無く失敗する                                      | L   |
| API 設計   | `doPost` が未定義の `action` に対して `saveUserCode_` を呼ぶため用途拡張が困難                | M   |
| API 設計   | `parseFormPost_` が `=` や `&` を含む値を正しくパースできない                             | H   |
| API 設計   | `saveTask_`/`saveUserCode_` に排他制御が無く同時書き込みでデータ競合の恐れ                      | M   |
| API 設計   | `getTasks_` がヘッダ行のみから列を推定し、列名の検証を行わない                                    | L   |
| クライアント   | 無効セッション時でも `session-ready` イベントを発火し続けるため API 呼び出しで突然 401 が発生する           | M   |
| クライアント   | `appendPlotDataUrl()` がプロットを出力バッファに保存せず、提出後に再現できない                       | M   |
| クライアント   | 課題切り替え時に `#commentBubble` が一瞬縦方向に膨らみ、コメント文が跳ねる（アニメーション完了前に本文を再描画している） | L   |
| クライアント   | ヒント開封の保存が失敗しても UI に通知されない                                                | L   |
| クライアント   | クロスオリジン分離が無い環境では Worker の割り込み (`SharedArrayBuffer`) が使えず `stop` が強制終了になる | L   |
| クライアント   | 課題エディタの保存失敗時に入力内容が失われる                                                   | L   |
| 環境依存     | CDN が遮断されると Pyodide/CodeMirror が読み込めず画面が動かない                             | H   |
| 環境依存     | HTTP 配布時に WebCrypto が使用できずハッシュ計算が遅い                                      | M   |
| 環境依存     | HTTPS 混在による Mixed Content 制限で通信がブロックされる                                  | M   |
| データ形式    | 改行や文字エンコードの処理が不十分で全角やサロゲートペアを含むコードが破損する                                  | L   |
| データ形式    | `data:image/png;base64,...` の出力を保存せず提出データに含めない                           | M   |
| 採点         | `getClassSubmissions` がクラス全員分の `<UserId>` シートを順次読み込むため、人数が増えるとレスポンス遅延や GAS の実行制限に達する恐れ | M   |
| 採点         | `saveScores` は `Submitted` が true の行のみ更新するため、提出フラグが残った課題は採点/再採点できない | M   |

## 詳細と推定原因

### セッション・認証
- ping POST 問題: index.html はセッション検証のため action=ping を POST しますが、GAS 側は GET のみ対応で doPost は全て saveUserCode_ にフォールバックします。そのため常に missing taskId エラーとなり、クライアントは catch で {status:'ok'} を返すため、無効セッションを検知できません。
- 無期限セッション: SESSION_TTL_MINUTES = 0 により validateSession_ が有効期限チェックを行わず、ユーザーがログアウトしない限り半永久的にレコードが残ります。セッション数が増え続けると検索負荷が高まりパフォーマンスが劣化するリスクがあります。
- 無認証 API: saveTask_ や saveUserCode_ は session が空でも ID だけで書き込み可能であり、他人のコードや課題を改竄できる構造です。アクセス制限や署名検証が必要です。
- SALT 露出: SALT とハッシュ値を GET クエリで送信しているため、サーバーログ・ブラウザ履歴・プロキシに認証情報が残るおそれがあります。HTTPS での通信が推奨されます。
- パスワード変更未実装: change_password.html にはパスワード変更フォームがありますが、Apps Script に対応する changePassword 関数が無く常にエラーとなります。機能追加が必要です。

### API 設計
- action スイッチ不足: doPost は getTasks、getUserSnapshot、saveTask を除く全ての POST を saveUserCode_ に回します。用途追加時に action を判別する仕組みがなく、誤ったハンドラが呼ばれる危険があります。
- フォームパースの欠陥: parseFormPost_ は split('&') で分割後 split('=') の最初の部分のみをキーとして解釈するため、値に = や & を含む場合に後半が欠落します。長いコードや base64 データ URI を送信するとデータが破損します。
- 排他制御の欠如: saveTask_ と saveUserCode_ は同時書き込みを考慮しておらず、授業中の集中的なアクセス時にデータの取り違えが発生する恐れがあります。トランザクション機構の導入が望まれます。
- 列名検証不足: getTasks_ はヘッダ行から列インデックスを推定するだけで列名チェックを行わないため、スプレッドシートで列削除や順序変更を行うとクライアントが空文字列を受け取ります。事前検証とバージョニングが必要です。


### 採点
- `getClassSubmissions` はクラス人数分の `<UserId>` シートを逐次読み込むため、大人数クラスではレスポンス遅延や GAS の実行時間超過に注意。
- `saveScores` は `Submitted=true` の行だけが対象のため、提出フラグが解除されていない課題は再採点できず運用上の詰まりになり得る。（2025-11-20 現在、grading.js から `force=true` を付与して再採点や未提出課題の採点を許容するワークアラウンドを導入済みだが、GAS 側の仕様が変わっていない点には留意する。）

### クライアント
- セッション無効時の挙動: main.js は index.html と同じく検証失敗時に clearSession() を呼ばず window.dispatchEvent('session-ready') を発火するため、無効セッションで API を呼び続け突然 401 エラーが返ることがあります。検証失敗時は即座にログアウトすべきです。
- プロットの保存欠落: appendPlotDataUrl() は DOM に <img> を追加する一方で outputBuffer には [plot] というプレースホルダしか保存せず、提出データや再読込後にグラフが復元できません。dataURI も保存するよう改修が必要です。
- ヒント保存の無通知: ヒントを開いた際に saveSpecificTask() が失敗しても UI には通知されず、提示済みフラグがサーバーと食い違う可能性があります。エラー表示を追加する必要があります。
- 割り込みの制限: クロスオリジン分離が無い環境では SharedArrayBuffer が無効で、workerCanInterrupt が false になり stop ボタンが強制終了 (kill) となります。途中で保存されないため注意が必要です。
- 課題エディタの入力損失: task_editor.js では saveTask 失敗時にステータスを更新するのみでフォーム内容を保持しないため、リロード等で入力が失われます。失敗時はフォーム内容を復元できるようにするべきです。

### 環境依存
- CDN 依存: Pyodide/CodeMirror/Matplotlib は cdn.jsdelivr.net に依存しており、学校や校内プロキシで CDN が遮断されると学習画面が初期化できません。ローカルキャッシュや代替 CDN の利用が必要です。
- HTTP と WebCrypto: register.html/login.html は HTTP 環境で WebCrypto が使用できない場合に JS 実装へフォールバックしますが、古い端末ではハッシュ計算に数秒かかりタイムアウトする恐れがあります。HTTPS での提供と端末性能の確認が望まれます。
- Mixed Content: config.js では HTTPS のベース URL を想定しており、HTTP/HTTPS 混在時はブラウザの Mixed Content 制限でブロックされます。HTTP 配布しかできない場合はサーバーも HTTP でそろえる必要があります。

### データ形式
- 文字エンコードと改行: CommPayload.createTaskSavePayload は \r\n を \n に正規化しますが、GAS の parseFormPost_ が + や %xx の復元しか行わないため、全角やサロゲートペアを含むコードが壊れる場合があります。文字列を JSON 形式で送受信する改修が必要です。
- グラフの提出欠落: appendPlotDataUrl() は dataURI を保存しないため、提出データにグラフが含まれません。採点時に出力を再現できない問題が発生します。

### 優先度・再発リスクの考え方
- High (H): セキュリティ上重大または授業進行に支障をきたすもの。セッションの無認証アクセスや CDN 依存などは優先的に対処すべきです。
- Medium (M): 機能制限やユーザー体験に影響するが回避策があるもの。例: セッション TTL 無期限、Mixed Content 問題、プロット保存欠落など。
- Low (L): 影響が限定的または改善が容易なもの。例: パスワード変更未実装、列名検証不足など。

各リスクに対する対策案や改善ロードマップはエージェント引き継ぎガイドに記載しています。
