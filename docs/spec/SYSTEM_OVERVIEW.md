# システム概要

## 授業目的
本システムは、高校生や初学者向けのプログラミング学習を支援するために設計されたウェブアプリケーションです。教員が用意した課題を生徒がオンラインで閲覧し、ブラウザ上の Python 環境（Pyodide）でコードを実行・提出できるようにします。課題の登録と編集は教員専用画面から行え、提出状況は Google スプレッドシートに保存されるため授業の進行管理を容易にします。

## 主要機能の一覧と説明
- 二段階ログインと新規登録 – login.html では ID 送信後に SALT を取得し、パスワードに結合してハッシュ化したものを送信する二段階認証を行います。register.html では未登録ユーザーの初期パスワード設定と自動ログインをサポートします。
- 課題一覧とコードエディタ – main.html では課題ツリーを表示し、クリックすると問題文・ヒント・コードエディタを読み込んで編集できます。CodeMirror ベースのエディタは Python 用の構文ハイライトとリント機能を備えています。
- プログラム実行と結果表示 – 実行ボタンでブラウザ内の Pyodide を呼び出し、入力や time.sleep() を非同期に処理しながらコードを実行します。Matplotlib によるグラフ出力は PNG データ URI として出力領域に表示されます。
- 保存と提出 – 編集したコードと出力をローカルキャッシュおよび GAS（Google Apps Script）へ保存し、提出ボタンで提出済みフラグを立てて編集をロックします。
- 課題エディタ – task_editor.html は教員用の課題作成画面で、フォルダ階層付きのツリーで課題を整理し、タイトル・説明文・ヒント・解答コード・初期コードを編集できます。
- セッション管理とローカルキャッシュ – index.html は localStorage のセッション情報を確認して main.html か login.html へ誘導し、課題一覧と生徒の進捗を先読みして learn.snapshot.<server> キーに保存します。

## 画面構成と簡易遷移図
以下のような画面遷移で構成されています。矢印は主要な導線を示します。

***
[ トップ画面 (index) ]
      │  セッション有効 → [ 学習画面 (main) ]
      └→ セッション無効
                ↓
          [ ログイン画面 (login) ] ← 新規登録 (register)
                 │ 成功時
                 └→ [ トップ画面 (index) ] → 学習画面

教員向けには URL 直打ちで [ 課題エディタ (task_editor) ] にアクセスできます。
***



各画面の主な UI 要素は以下のとおりです。
- index.html – メイン遷移ボタン#primaryBtn、クラス/番号表示#meta、セッション検証用のメッセージを表示するエリア#note、プリロード状態を示す#preloadStatus。
- login.html – ID入力フォーム#idFormとPW入力フォーム#pwForm、ユーザー ID フィールド#loginId、パスワードフィールド#loginPassword など。
- main.html – 課題リストを表示する#tasksとツリーの折りたたみトグル、問題表示領域#problemTitleと#problemText、ヒント表示ボタン#hintButton、コードエディタ#editor、出力領域#outputArea、実行/停止/保存/提出などのボタン群#runButton・#stopButton・#saveButton・#submitButton、支援機能のトグル#assistToggle。
- task_editor.html – 左ペインにフォルダツリー#taskTree、中央に課題情報フォーム（ID、タイトル、親フォルダ ID、説明 HTML、ヒント HTML）、右側に解答用・初期用の CodeMirror エディタ。


## 利用シナリオ

【生徒の流れ】
1. アクセスとセッション検証 – 生徒は学習サイトのトップ（index.html）にアクセスします。ページは localStorage のセッション情報と URL パラメータの sid を検証し、セッションが有効なら直接学習画面へのボタンを表示します。
2. ログイン – セッションが無い場合、ログイン画面に遷移します。ID を入力すると Apps Script からユーザー固有の SALT が返り、次にパスワードと結合して SHA-256 ハッシュを送信します。
3. 課題選択と学習 – 学習画面では左側の課題ツリーから問題を選び、中央の説明文やヒントを読みながら右側のエディタでプログラムを作成します。実行ボタンでコードを試行し、満足したら保存または提出します。
4. 進捗の保存 – セッション中に変更したコードや出力は自動的にブラウザ内のキャッシュに保存され、手動保存時には GAS 経由でスプレッドシートにも書き込まれます。再訪時には最後に開いていた課題やコードが復元されます。

【教員の流れ】
1. 課題エディタへのアクセス – 教員は専用 URL で task_editor.html にアクセスします。ログインしていなくても UI は閲覧可能ですが、保存時にはセッションが必要です。
2. 課題の作成・編集 – 左ペインでフォルダや課題を選択し、中央フォームにタイトル・説明文・ヒント、右側の CodeMirror に解答例や初期コードを入力して保存します。新規課題は自動採番されます。
3. 生徒画面への反映 – 保存後は task シートに書き込まれ、main.html の getTasks 呼び出しや index.html のスナップショットプリロードで最新の課題が読み込まれます。

## 教室環境での注意点
- インターネット接続 – Pyodide・CodeMirror・Matplotlib などの主要ライブラリは cdn.jsdelivr.net から読み込まれます。校内ネットワークのフィルタ（iFILTER など）やオフライン環境では CDN への接続が遮断され、学習画面が初期化できないことがあります。授業前にアクセス確認を行うか、ローカルにライブラリをホストする準備が必要です。
- HTTP/HTTPS 混在 – config.js ではサーバー URL を HTTPS で指定しており、HTTP 配布環境では Mixed Content 制限により通信がブロックされます。学校 PC が HTTP のみを許可する場合は、サーバー側のプロトコルを合わせるかローカル配布に切り替えてください。
- WebCrypto とハッシュ計算 – SALT+パスワードのハッシュ計算には WebCrypto API を利用しますが、HTTP 環境や古いブラウザでは動作しません。その場合は純粋な JS 実装が利用されますが処理に時間がかかるため、ログイン時に数秒の待ち時間が発生します。
- データ保存の信頼性 – 課題保存や提出は GAS 経由で Google スプレッドシートに書き込まれますが、授業中の集中アクセスや通信断時には保存に失敗する場合があります。生徒にはこまめな手動保存と、提出前に出力内容を確認するよう指導してください。

## 研究発表・実践報告への利用
本ドキュメントは教員向けの実践報告や研究発表資料としても利用できるよう、システムの目的・機能・運用手順を整理しました。実際の授業では、上記の注意点を踏まえてネットワーク環境や端末性能を事前確認し、セッション管理やデータ保存に関する制約を共有しておくことが重要です。また、既知の不具合や改良予定については別紙「BUGS_AND_RISKS.md」を参照してください。
