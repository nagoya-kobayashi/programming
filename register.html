<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新規登録 | プログラミング学習</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="config.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    .wrap { max-width: 720px; margin: 40px auto; padding: 24px; border: 1px solid #eee; border-radius: 12px; }
    .row { margin: 12px 0; }
    label { display: block; margin-bottom: 6px; color: #444; }
    input[readonly] { background: #f7f7f7; }
    input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 16px; border-radius: 8px; background: #1677ff; color: #fff; border: 1px solid #1677ff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .msg { margin-top: 8px; color: #888; }
    .error { color: #d93025; }
    .ok { color: #188038; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>新規登録</h1>
    <div id="gateMsg" class="msg"></div>

    <div id="formBlock" style="display:none;">
      <div class="row">
        <label>ユーザID</label>
        <input id="regUserId" readonly />
      </div>
      <div class="row">
        <label>クラス</label>
        <input id="regClass" readonly />
      </div>
      <div class="row">
        <label>出席番号</label>
        <input id="regNumber" readonly />
      </div>
      <div class="row">
        <label>パスワード</label>
        <input id="regPw" type="password" />
      </div>
      <div class="row">
        <label>パスワード（確認）</label>
        <input id="regPw2" type="password" />
      </div>
      <div class="row">
        <button id="regSubmit">登録する</button>
      </div>
      <div id="regMsg" class="msg"></div>
    </div>
  </div>

  <script>
    (function(){
      const APP = window.APP_CONFIG || {};
      const server = APP.serverBaseUrl || '';

      const gateMsg = document.getElementById('gateMsg');
      const formBlock = document.getElementById('formBlock');
      const idEl = document.getElementById('regUserId');
      const clsEl = document.getElementById('regClass');
      const numEl = document.getElementById('regNumber');
      const pwEl = document.getElementById('regPw');
      const pw2El = document.getElementById('regPw2');
      const regMsg = document.getElementById('regMsg');
      const btn = document.getElementById('regSubmit');

      function setGate(msg, ok=false){ gateMsg.textContent = msg; gateMsg.className = 'msg ' + (ok ? 'ok':'error'); }
      function setRegMsg(msg, ok=false){ regMsg.textContent = msg; regMsg.className = 'msg ' + (ok ? 'ok':'error'); }
      function getParam(k){ return new URLSearchParams(location.search).get(k); }

      function randSalt3(){
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
        let s=''; for (let i=0;i<3;i++){ s += chars[Math.floor(Math.random()*chars.length)]; }
        return s;
      }
      async function sha256Hex(text){
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b => b.toString(16).padStart(2, '0')).join('');
      }
      async function fetchJson(url){
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      }

      async function init(){
        // 既にログイン済みなら main.html へ
        const sid = localStorage.getItem('sessionId');
        if (sid){
          location.href = 'main.html';
          return;
        }
        const idRaw = getParam('id');
        const id = (idRaw || '').trim();
        if (!id){ setGate('IDが指定されていません。', false); return; }
        if (!server){ setGate('サーバURL未設定です(config.js)。', false); return; }

        setGate('ユーザ確認中...');
        try {
          const url = server + '?action=getUserMeta&id=' + encodeURIComponent(id);
          const meta = await fetchJson(url);
          console.log('[Register] getUserMeta response:', meta);
          if (!meta || meta.status !== 'ok' || !meta.exists){
            setGate('IDが無効です。', false);
            return;
          }
          // 既にPW設定済み → login.html へ
          if (meta.passwordSet){
            setGate('すでに登録済みです。ログイン画面に移動します。', true);
            setTimeout(()=>{ location.href = 'login.html?id=' + encodeURIComponent(id); }, 800);
            return;
          }

          // 初回登録フォームを表示（ID/クラス/番号は固定表示）
          idEl.value = id;
          clsEl.value = meta.classId || '';
          numEl.value = meta.number || '';
          formBlock.style.display = '';

          btn.onclick = async () => {
            const p1 = pwEl.value || '';
            const p2 = pw2El.value || '';
            if (!p1 || !p2){ setRegMsg('パスワードを入力してください', false); return; }
            if (p1 !== p2){ setRegMsg('パスワードが一致しません', false); return; }
            btn.disabled = true;
            setRegMsg('登録処理中...');

            try{
              const salt = randSalt3();
              const hash = await sha256Hex(salt + p1);
              const setRes = await fetchJson(server + '?action=initPassword&id=' + encodeURIComponent(id) + '&salt=' + encodeURIComponent(salt) + '&passwordHash=' + encodeURIComponent(hash));
              console.log('[Register] initPassword response:', setRes);
              if (!setRes || setRes.status !== 'ok'){
                btn.disabled = false;
                setRegMsg((setRes && setRes.message) || '登録に失敗しました。', false);
                return;
              }
              const loginRes = await fetchJson(server + '?action=login&id=' + encodeURIComponent(id) + '&passwordHash=' + encodeURIComponent(hash));
              console.log('[Register] login response:', loginRes);
              if (loginRes && loginRes.status === 'ok' && loginRes.sessionId){
                try { localStorage.clear(); } catch {}
                try {
                  localStorage.setItem('sessionId', loginRes.sessionId);
                  localStorage.setItem('userId', loginRes.userId || id);
                  localStorage.setItem('classId', loginRes.classId || '');
                  localStorage.setItem('number', loginRes.number || '');
                  sessionStorage.setItem('sessionId', loginRes.sessionId);
                  sessionStorage.setItem('userId', loginRes.userId || id);
                  sessionStorage.setItem('classId', loginRes.classId || '');
                  sessionStorage.setItem('number', loginRes.number || '');
                } catch {}
                setRegMsg('登録が完了しました。トップページへ移動します。', true);
                setTimeout(()=>{ location.href = 'index.html'; }, 700);
              } else {
                btn.disabled = false;
                setRegMsg('登録は完了しましたが、ログインに失敗しました。login.html からログインしてください。', false);
              }
            }catch(err){
              btn.disabled = false;
              console.error(err);
              setRegMsg('通信エラーが発生しました。', false);
            }
          };

          setGate('初回登録が必要です。以下にパスワードを設定してください。', true);
        } catch (err) {
          console.error(err);
          setGate('通信に失敗しました。', false);
        }
      }

      init();
    })();
  </script>
</body>
</html>
