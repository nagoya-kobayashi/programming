<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新規登録 | プログラミング学習</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="config.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    .wrap { max-width: 720px; margin: 40px auto; padding: 24px; border: 1px solid #eee; border-radius: 12px; }
    .row { margin: 12px 0; }
    label { display: block; margin-bottom: 6px; color: #444; }
    input[readonly] { background: #f7f7f7; }
    input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 16px; border-radius: 8px; background: #1677ff; color: #fff; border: 1px solid #1677ff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .msg { margin-top: 8px; color: #888; }
    .error { color: #d93025; }
    .ok { color: #188038; }
    .hint { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>新規登録</h1>
    <div id="gateMsg" class="msg"></div>

    <div id="formBlock" style="display:none;">
      <div class="row">
        <label>ユーザID</label>
        <input id="regUserId" readonly />
      </div>
      <div class="row">
        <label>クラス</label>
        <input id="regClass" readonly />
      </div>
      <div class="row">
        <label>出席番号</label>
        <input id="regNumber" readonly />
      </div>
      <div class="row">
        <label>パスワード</label>
        <input id="regPw" type="password" autocomplete="new-password" />
      </div>
      <div class="row">
        <label>パスワード（確認）</label>
        <input id="regPw2" type="password" autocomplete="new-password" />
      </div>
      <div class="row">
        <button id="regSubmit">登録する</button>
      </div>
      <div id="regMsg" class="msg"></div>
      <div id="secHint" class="hint"></div>
    </div>
  </div>

  <script>
    (function(){
      const APP = window.APP_CONFIG || {};
      const server = APP.serverBaseUrl || '';

      const gateMsg = document.getElementById('gateMsg');
      const formBlock = document.getElementById('formBlock');
      const idEl = document.getElementById('regUserId');
      const clsEl = document.getElementById('regClass');
      const numEl = document.getElementById('regNumber');
      const pwEl = document.getElementById('regPw');
      const pw2El = document.getElementById('regPw2');
      const regMsg = document.getElementById('regMsg');
      const btn = document.getElementById('regSubmit');
      const secHint = document.getElementById('secHint');

      function setGate(msg, ok=false){ gateMsg.textContent = msg; gateMsg.className = 'msg ' + (ok ? 'ok':'error'); }
      function setRegMsg(msg, ok=false){ regMsg.textContent = msg; regMsg.className = 'msg ' + (ok ? 'ok':'error'); }
      function getParam(k){ return new URLSearchParams(location.search).get(k); }

      function randSalt3(){
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
        let s=''; for (let i=0;i<3;i++){ s += chars[Math.floor(Math.random()*chars.length)]; }
        return s;
      }

      // ---- SHA-256: WebCrypto が使えない環境(http 等)向けフォールバック ----
      const hasSubtle = !!(window.crypto && crypto.subtle);
      async function sha256Hex(text){
        if (hasSubtle){
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
          const arr = Array.from(new Uint8Array(buf));
          return arr.map(b => b.toString(16).padStart(2, '0')).join('');
        } else {
          return sha256_purejs(text);
        }
      }
      // できるだけ短い純JS実装（UTF-8 → SHA-256 → hex）
      function sha256_purejs(str){
        // UTF-8 encode
        const utf8 = new TextEncoder().encode(str);
        // Convert to words
        const words = [];
        for (let i=0;i<utf8.length;i++){
          words[(i>>2)] |= utf8[i] << (24 - (i%4)*8);
        }
        // Append '1' bit and length
        const bitLen = utf8.length * 8;
        words[bitLen >> 5] |= 0x80 << (24 - (bitLen % 32));
        words[((bitLen + 64 >> 9) << 4) + 15] = bitLen;

        // Constants
        const K = [
          0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,
          0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,
          0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,
          0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,
          0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,
          0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,
          0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,
          0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2
        ];
        let H0=0x6a09e667, H1=0xbb67ae85, H2=0x3c6ef372, H3=0xa54ff53a,
            H4=0x510e527f, H5=0x9b05688c, H6=0x1f83d9ab, H7=0x5be0cd19;

        const W = new Array(64);
        for (let i=0;i<words.length;i+=16){
          for (let t=0;t<16;t++) W[t]=words[i+t]||0;
          for (let t=16;t<64;t++){
            const s0 = (ROTR(W[t-15],7)) ^ (ROTR(W[t-15],18)) ^ (W[t-15]>>>3);
            const s1 = (ROTR(W[t-2],17)) ^ (ROTR(W[t-2],19)) ^ (W[t-2]>>>10);
            W[t] = (W[t-16] + s0 + W[t-7] + s1) | 0;
          }
          let a=H0,b=H1,c=H2,d=H3,e=H4,f=H5,g=H6,h=H7;
          for (let t=0;t<64;t++){
            const S1 = ROTR(e,6) ^ ROTR(e,11) ^ ROTR(e,25);
            const ch = (e & f) ^ (~e & g);
            const temp1 = (h + S1 + ch + K[t] + W[t]) | 0;
            const S0 = ROTR(a,2) ^ ROTR(a,13) ^ ROTR(a,22);
            const maj = (a & b) ^ (a & c) ^ (b & c);
            const temp2 = (S0 + maj) | 0;
            h=g; g=f; f=e; e=(d + temp1) | 0; d=c; c=b; b=a; a=(temp1 + temp2) | 0;
          }
          H0=(H0+a)|0; H1=(H1+b)|0; H2=(H2+c)|0; H3=(H3+d)|0; H4=(H4+e)|0; H5=(H5+f)|0; H6=(H6+g)|0; H7=(H7+h)|0;
        }
        function ROTR(x,n){ return (x>>>n)|(x<<(32-n)); }
        function toHex(x){ return ('00000000'+(x>>>0).toString(16)).slice(-8); }
        return toHex(H0)+toHex(H1)+toHex(H2)+toHex(H3)+toHex(H4)+toHex(H5)+toHex(H6)+toHex(H7);
      }

      async function fetchJson(url){
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      }

      async function init(){
        // 既にログイン済みなら index.html へ
        const sid = localStorage.getItem('sessionId');
        if (sid){
          location.href = 'index.html';
          return;
        }
        const idRaw = getParam('id');
        const id = (idRaw || '').trim();
        if (!id){ setGate('IDが指定されていません。', false); return; }
        if (!server){ setGate('サーバURL未設定です(config.js)。', false); return; }

        setGate('ユーザ確認中...');
        try {
          const url = server + '?action=getUserMeta&id=' + encodeURIComponent(id);
          const meta = await fetchJson(url);
          console.log('[Register] getUserMeta response:', meta);
          if (!meta || meta.status !== 'ok' || !meta.exists){
            setGate('IDが無効です。', false);
            return;
          }
          // 既にPW設定済み → login.html へ
          if (meta.passwordSet){
            setGate('すでに登録済みです。ログイン画面に移動します。', true);
            setTimeout(()=>{ location.href = 'login.html?id=' + encodeURIComponent(id); }, 800);
            return;
          }

          // 初回登録フォームを表示（ID/クラス/番号は固定表示）
          idEl.value = id;
          clsEl.value = meta.classId || '';
          numEl.value = meta.number || '';
          formBlock.style.display = '';

          // http 環境の注意表示
          if (!window.isSecureContext || !hasSubtle){
            secHint.textContent = '参考: 現在の接続は HTTP のため、ブラウザ標準の暗号APIは使用せず JS 実装でハッシュ化しています。可能なら HTTPS での利用を推奨します。';
          }

          btn.onclick = async () => {
            const p1 = pwEl.value || '';
            const p2 = pw2El.value || '';
            if (!p1 || !p2){ setRegMsg('パスワードを入力してください', false); return; }
            if (p1 !== p2){ setRegMsg('パスワードが一致しません', false); return; }
            btn.disabled = true;
            setRegMsg('登録処理中...');

            try{
              const salt = randSalt3();
              const hash = await sha256Hex(salt + p1);
              const setRes = await fetchJson(
                server + '?action=initPassword&id=' + encodeURIComponent(id)
                + '&salt=' + encodeURIComponent(salt)
                + '&passwordHash=' + encodeURIComponent(hash)
              );
              console.log('[Register] initPassword response:', setRes);
              if (!setRes || setRes.status !== 'ok'){
                btn.disabled = false;
                setRegMsg((setRes && setRes.message) || '登録に失敗しました。', false);
                return;
              }
              const loginRes = await fetchJson(
                server + '?action=login&id=' + encodeURIComponent(id)
                + '&passwordHash=' + encodeURIComponent(hash)
              );
              console.log('[Register] login response:', loginRes);
              if (loginRes && loginRes.status === 'ok' && loginRes.sessionId){
                try { localStorage.clear(); } catch {}
                try {
                  localStorage.setItem('sessionId', loginRes.sessionId);
                  localStorage.setItem('userId', loginRes.userId || id);
                  localStorage.setItem('classId', loginRes.classId || '');
                  localStorage.setItem('number', loginRes.number || '');
                  sessionStorage.setItem('sessionId', loginRes.sessionId);
                  sessionStorage.setItem('userId', loginRes.userId || id);
                  sessionStorage.setItem('classId', loginRes.classId || '');
                  sessionStorage.setItem('number', loginRes.number || '');
                } catch {}
                setRegMsg('登録が完了しました。トップページへ移動します。', true);
                setTimeout(()=>{ location.href = 'index.html'; }, 700);
              } else {
                btn.disabled = false;
                setRegMsg('登録は完了しましたが、ログインに失敗しました。login.html からログインしてください。', false);
              }
            }catch(err){
              btn.disabled = false;
              console.error(err);
              setRegMsg('通信エラーが発生しました。', false);
            }
          };

          setGate('初回登録が必要です。以下にパスワードを設定してください。', true);
        } catch (err) {
          console.error(err);
          setGate('通信に失敗しました。', false);
        }
      }

      init();
    })();
  </script>
</body>
</html>
